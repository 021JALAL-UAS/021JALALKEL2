<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PZEM Dashboard – Tema C</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Gauge library -->
<script src="https://cdn.jsdelivr.net/npm/@berwin/gauge.js"></script>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">

<style>
  body {
    margin: 0;
    padding: 0;
    background: #081b29;
    font-family: "Montserrat", sans-serif;
    color: #e0f7fa;
  }

  h2 {
    text-align: center;
    padding: 20px 0;
    color: #4dd0e1;
    letter-spacing: 1px;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 25px;
    padding: 20px;
  }

  .card {
    padding: 15px;
    background: #0a2336;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 255, 255, 0.15);
  }

  .value-box {
    font-size: 32px;
    font-weight: bold;
    text-align: center;
    padding: 8px 0;
    color: #4dd0e1;
  }

  canvas {
    margin-top: 15px;
  }
</style>
</head>
<body>

<h2>PZEM DASHBOARD – Tema C (6 Data)</h2>

<div class="grid">

  <!-- ===================== 1. TEGANGAN ===================== -->
  <div class="card">
    <h3>Tegangan (V)</h3>
    <div id="volt_val" class="value-box">--</div>
    <canvas id="volt_gauge" width="250" height="150"></canvas>
    <canvas id="volt_chart"></canvas>
  </div>

  <!-- ===================== 2. ARUS ===================== -->
  <div class="card">
    <h3>Arus (A)</h3>
    <div id="arus_val" class="value-box">--</div>
    <canvas id="arus_gauge" width="250" height="150"></canvas>
    <canvas id="arus_chart"></canvas>
  </div>

  <!-- ===================== 3. DAYA ===================== -->
  <div class="card">
    <h3>Daya (W)</h3>
    <div id="daya_val" class="value-box">--</div>
    <canvas id="daya_gauge" width="250" height="150"></canvas>
    <canvas id="daya_chart"></canvas>
  </div>

  <!-- ===================== 4. ENERGI ===================== -->
  <div class="card">
    <h3>Energi (kWh)</h3>
    <div id="kwh_val" class="value-box">--</div>
    <canvas id="kwh_gauge" width="250" height="150"></canvas>
    <canvas id="kwh_chart"></canvas>
  </div>

  <!-- ===================== 5. FREKUENSI ===================== -->
  <div class="card">
    <h3>Frekuensi (Hz)</h3>
    <div id="frek_val" class="value-box">--</div>
    <canvas id="frek_gauge" width="250" height="150"></canvas>
    <canvas id="frek_chart"></canvas>
  </div>

  <!-- ===================== 6. POWER FACTOR ===================== -->
  <div class="card">
    <h3>Power Factor</h3>
    <div id="pf_val" class="value-box">--</div>
    <canvas id="pf_gauge" width="250" height="150"></canvas>
    <canvas id="pf_chart"></canvas>
  </div>

</div>

<!-- MQTT -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<script>
// =====================================
// GAUGE SETUP
// =====================================
function createGauge(canvasId, min, max) {
  return new Gauge({
    canvas: document.getElementById(canvasId),
    minValue: min,
    maxValue: max,
    value: 0,
    colorNumbers: "#4dd0e1"
  });
}

let gauge_volt = createGauge("volt_gauge", 0, 300);
let gauge_arus = createGauge("arus_gauge", 0, 20);
let gauge_daya = createGauge("daya_gauge", 0, 5000);
let gauge_kwh  = createGauge("kwh_gauge", 0, 999);
let gauge_frek = createGauge("frek_gauge", 40, 70);
let gauge_pf   = createGauge("pf_gauge", 0, 1);

// =====================================
// CHART SETUP
// =====================================
function createSmoothChart(id, label) {
  return new Chart(document.getElementById(id), {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: label,
        data: [],
        borderWidth: 2,
        borderColor: "#4dd0e1",
        fill: false,
        tension: 0.4   // SMOOTH line
      }]
    },
    options: {
      responsive: true,
      animation: false,
      scales: {
        x: { display: false },
        y: { grid: { color: "#0d2f44" } }
      }
    }
  });
}

let chart_volt = createSmoothChart("volt_chart", "Volt");
let chart_arus = createSmoothChart("arus_chart", "Arus");
let chart_daya = createSmoothChart("daya_chart", "Daya");
let chart_kwh  = createSmoothChart("kwh_chart", "Energi");
let chart_frek = createSmoothChart("frek_chart", "Frekuensi");
let chart_pf   = createSmoothChart("pf_chart", "Power Factor");

// Tambah data ke grafik
function pushChart(chart, value) {
  const t = new Date().toLocaleTimeString();

  chart.data.labels.push(t);
  chart.data.datasets[0].data.push(value);

  if (chart.data.labels.length > 20) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update();
}

// =====================================
// MQTT
// =====================================
const client = new Paho.MQTT.Client(
  "test.mosquitto.org",
  8081,
  "/mqtt",
  "dashboard-" + Date.now()
);

client.onMessageArrived = (msg) => {
  try {
    const d = JSON.parse(msg.payloadString);

    // TAMPILAN ANGKA
    volt_val.textContent = d.volt;
    arus_val.textContent = d.arus;
    daya_val.textContent = d.daya;
    kwh_val.textContent  = d.kwh;
    frek_val.textContent = d.frek;
    pf_val.textContent   = d.pf;

    // GAUGE
    gauge_volt.setValue(d.volt);
    gauge_arus.setValue(d.arus);
    gauge_daya.setValue(d.daya);
    gauge_kwh.setValue(d.kwh);
    gauge_frek.setValue(d.frek);
    gauge_pf.setValue(d.pf);

    // GRAFIK
    pushChart(chart_volt, d.volt);
    pushChart(chart_arus, d.arus);
    pushChart(chart_daya, d.daya);
    pushChart(chart_kwh,  d.kwh);
    pushChart(chart_frek, d.frek);
    pushChart(chart_pf,   d.pf);

  } catch (e) {
    console.log("JSON Error:", msg.payloadString);
  }
};

client.connect({
  useSSL: true,
  onSuccess: () => {
    console.log("MQTT Connected");
    client.subscribe("/aisi555/pzem");
  }
});
</script>

</body>
</html>
